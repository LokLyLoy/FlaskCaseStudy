{% extends "/layout/layout.html" %}

{% block style %}
	<link rel="stylesheet" href="../../static/styles/homepage.css">
{% endblock %}

{% block content %}
	<main>
        <div class="hero-banner">
            <img src="../../static/images/banner.png" alt="banner" class="hero-img">

            <div class="hero-text">
                <h1>Welcome to Ly's E-Commerce</h1>
                <p>Shop the latest products with exclusive deals</p>

                <a href="#" class="next-btn">
                    <span class="shop-btn">Shop Now</span>

                    <div class="icon-circle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 42 42">
                            <path fill="currentColor" fill-rule="evenodd"
                                d="M13.933 1L34 21.068L14.431 40.637l-4.933-4.933l14.638-14.636L9 5.933z"></path>
                        </svg>
                    </div>
                </a>
            </div>
        </div>

        <div class="category">
            <h2>Browse by Categories</h2>
            <div class="category-buttons">
                <a href="/category" class="category-btn">Men</a>
                <a href="/category" class="category-btn">Women</a>
                <a href="/category" class="category-btn">Children</a>
            </div>
        </div>

        <div class="category-section">
            <div class="category-item">
                <img src="../../static/images/men.jpg" alt="men">
                <button class="category-btn-img">Men</button>
            </div>
            <div class="category-item">
                <img src="../../static/images/women.jpg" alt="women">
                <button class="category-btn-img">Women</button>
            </div>
            <div class="category-item">
                <img src="../../static/images/children.jpg" alt="children">
                <button class="category-btn-img">Children</button>
            </div>
        </div>

        <div class="products-container">
            <h2>Products List</h2>
            <div class="product-grid">
                {% for product in products %}
                <div class="product-card" data-product-id="{{ product.id }}">

                    <!-- Product Image -->
                    <div class="product-img-box">
                        <img src="{{ product.image }}" alt="{{ product.name }}">
                    </div>

                    <!-- Info -->
                    <h3 class="product-name">{{ product.name }}</h3>
                    <p class="product-category">{{ product.category }}</p>
                    <p class="product-description">{{ product.description }}</p>

                    <div class="price-row">
                        <span class="price">${{ product.price }}</span>

                        <div class="qty-box">
                            <button class="qty-btn minus" type="button">âˆ’</button>
                                <input type="text" class="qty-input" min="1" value="1">
                            <button class="qty-btn plus" type="button">+</button>
                        </div>
                    </div>

                    <button class="add-btn" type="button">
                        <svg width="22px" height="22px">
                            <use href="/static/svg/sprite.svg#cart-icon"></use>
                        </svg>
                        ADD TO CART
                    </button>

                </div>
                {% endfor %}
            </div>
        </div>

    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize cart if it doesn't exist
            if (!localStorage.getItem('cart')) {
                localStorage.setItem('cart', JSON.stringify([]));
            }

            // Add event listeners to all product cards
            document.querySelectorAll(".product-card").forEach(card => {
                const minus = card.querySelector(".minus");
                const plus = card.querySelector(".plus");
                const qtyInput = card.querySelector(".qty-input");
                const addBtn = card.querySelector(".add-btn");

                // Minus button
                minus.addEventListener("click", (e) => {
                    e.preventDefault();
                    let val = parseInt(qtyInput.value);
                    if (!isNaN(val) && val > 1) {
                        qtyInput.value = val - 1;
                    }
                });

                // Plus button
                plus.addEventListener("click", (e) => {
                    e.preventDefault();
                    let val = parseInt(qtyInput.value);
                    if (!isNaN(val)) {
                        qtyInput.value = val + 1;
                    } else {
                        qtyInput.value = 1;
                    }
                });

                // Add to cart button
                addBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    addToCart(card);
                });
            });

            function addToCart(card) {
                // Get product data from the card
                const productId = card.dataset.productId;

                // Get product name
                const nameElement = card.querySelector(".product-name");
                const name = nameElement ? nameElement.textContent.trim() : "Unknown Product";

                // Get price (remove $ sign)
                const priceElement = card.querySelector(".price");
                const priceText = priceElement ? priceElement.textContent : "$0";
                const price = parseFloat(priceText.replace('$', '')) || 0;

                // Get image
                const imageElement = card.querySelector(".product-img-box img");
                const image = imageElement ? imageElement.src : "";

                // Get quantity
                const qtyInput = card.querySelector(".qty-input");
                let quantity = 1;
                if (qtyInput) {
                    const qtyValue = parseInt(qtyInput.value);
                    quantity = isNaN(qtyValue) || qtyValue < 1 ? 1 : qtyValue;
                }

                // Get category
                const categoryElement = card.querySelector(".product-category");
                const category = categoryElement ? categoryElement.textContent.trim() : "";

                // Get description
                const descriptionElement = card.querySelector(".product-description");
                const description = descriptionElement ? descriptionElement.textContent.trim() : "";

                // Get current cart from localStorage
                let cart = JSON.parse(localStorage.getItem("cart")) || [];

                // Check if product already exists in cart
                const existingProductIndex = cart.findIndex(item => item.id === productId);

                if (existingProductIndex !== -1) {
                    // Update quantity if product exists
                    cart[existingProductIndex].quantity += quantity;
                } else {
                    // Add new product to cart
                    cart.push({
                        id: productId,
                        name: name,
                        price: price,
                        image: image,
                        quantity: quantity,
                        category: category,
                        description: description
                    });
                }

                // Save cart back to localStorage
                localStorage.setItem("cart", JSON.stringify(cart));

                // Show visual feedback
                showFeedback(card);

                // Update cart count in header
                updateCartCount();
                
                // Dispatch cart update event for layout
                window.dispatchEvent(new CustomEvent('cartUpdated'));
            }

            function showFeedback(card) {
                const btn = card.querySelector(".add-btn");
                const originalHTML = btn.innerHTML;
                const originalBgColor = btn.style.backgroundColor;

                // Change button to show "ADDED!"
                btn.innerHTML = `
                    <svg width="22px" height="22px">
                        <use href="/static/svg/sprite.svg#cart-icon"></use>
                    </svg>
                    ADDED!
                `;
                btn.style.backgroundColor = "#28a745";
                btn.disabled = true;

                // Reset button after 1.2 seconds
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.backgroundColor = originalBgColor;
                    btn.disabled = false;
                }, 1200);
            }

            function updateCartCount() {
                const cart = JSON.parse(localStorage.getItem("cart")) || [];
                const totalItems = cart.reduce((total, item) => total + item.quantity, 0);

                // Find the cart count badge in the header
                const badge = document.querySelector(".cart-count");

                if (badge) {
                    badge.textContent = totalItems;
                    if (totalItems > 0) {
                        badge.style.display = "inline-flex";
                    } else {
                        badge.style.display = "none";
                    }
                }
            }

            // Initialize cart count on page load
            updateCartCount();
        });
    </script>

{% endblock %}
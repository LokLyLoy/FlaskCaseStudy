<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Case Study</title>
    <link rel="stylesheet" href="../../static/styles/layout.css">
    <link rel="icon" href="../../static/images/Logo.jpg">

    {% block style %}  {% endblock %}

</head>
<header>
    <div class="topbar">
        <a href="/" class="logo">
            <h2>Ly's E-Commerce</h2>
        </a>

        <nav class="navbar">
            <div class="nav-container">
                <a href="/" class="nav-link {% if request.path == '/' %}active{% endif %}">
                    Home
                    <span class="underline"></span>
                </a>

                <a href="/about" class="nav-link {% if request.path == '/about' %}active{% endif %}">
                    About
                    <span class="underline"></span>
                </a>

                <a href="/contact" class="nav-link {% if request.path == '/contact' %}active{% endif %}">
                    Contact
                    <span class="underline"></span>
                </a>
            </div>
        </nav>


        <div class="right" id="user-area">
            {% if user %}
                <div class="profile">
                    <div class="avatar-wrapper" id="profile">
                        <img src="/static/avatars/{{ user.avatar }}" alt="Avatar" class="avatar"/>
                    </div>
                    <span class="username">{{ user.username }}</span>
                </div>

                <button id="logoutBtn" class="logout-btn">Logout</button>
            {% endif %}

            <button class="cart-btn" id="cart">
                <svg class="cart-icon-layout" aria-hidden="true">
                    <use href="/static/svg/sprite.svg#cart"></use>
                </svg>
                Cart
                <span class="cart-count" id="cart-count">0</span>
            </button>
        </div>

    </div>
</header>

<body>
<!-- Alert Modal (replaces JS alert()) -->
<div id="alert-modal" class="alert-modal" aria-hidden="true">
    <div class="alert-modal__backdrop" data-alert-close></div>
    <div class="alert-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="alert-modal-title">
        <button class="alert-modal__close" type="button" aria-label="Close" data-alert-close>&times;</button>
        <div class="alert-modal__content">
            <div id="alert-modal-title" class="alert-modal__title">Notification</div>
            <div id="alert-modal-message" class="alert-modal__message"></div>
        </div>
    </div>
</div>

{% block content %} {% endblock %}
</body>

<footer>
    <div class="footer-container">
        <div class="footer-left">
            <h3>Ly's E-Commerce</h3>
            <p>Â© <span id="year"></span> Ngor Pavly. All rights reserved.</p>
        </div>

        <div class="footer-right">
            <a href="/">Home</a>
            <a href="/about">About</a>
            <a href="/contact">Contact</a>
        </div>
    </div>
</footer>

</html>

<script>
    // Global alert modal helper (auto closes; has close button)
    (function () {
        const modal = document.getElementById('alert-modal');
        const messageEl = document.getElementById('alert-modal-message');
        let timerId = null;

        function close() {
            if (!modal) return;
            if (timerId) {
                clearTimeout(timerId);
                timerId = null;
            }
            modal.classList.remove('is-open', 'is-success', 'is-error', 'is-warning', 'is-info');
            modal.setAttribute('aria-hidden', 'true');
        }

        window.showAlertModal = function (message, options) {
            if (!modal || !messageEl) {
                // Fallback if modal is missing for any reason
                // eslint-disable-next-line no-alert
                alert(String(message ?? ''));
                return;
            }

            const opts = options || {};
            const type = (opts.type || 'info').toLowerCase();
            const duration = typeof opts.duration === 'number' ? opts.duration : 2000;

            modal.classList.remove('is-success', 'is-error', 'is-warning', 'is-info');
            if (type === 'success') modal.classList.add('is-success');
            else if (type === 'error') modal.classList.add('is-error');
            else if (type === 'warning') modal.classList.add('is-warning');
            else modal.classList.add('is-info');

            messageEl.textContent = String(message ?? '');
            modal.classList.add('is-open');
            modal.setAttribute('aria-hidden', 'false');

            if (timerId) clearTimeout(timerId);
            timerId = setTimeout(close, Math.max(0, duration));
        };

        document.addEventListener('click', (e) => {
            const target = e.target;
            if (target && target.matches && target.matches('[data-alert-close]')) {
                close();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') close();
        });
    })();

    const cart = document.getElementById("cart");
    if (cart) {
        cart.addEventListener("click", () => {
            window.location.href = "/cart";
        });
    }

    const profileClick = document.getElementById("profile");
    if (profileClick) {
        profileClick.addEventListener("click", () => {
            window.location.href = "/dashboard";
        });
    }

    const currentYear = new Date().getFullYear();
    document.getElementById("year").textContent = currentYear;

    document.addEventListener('DOMContentLoaded', function () {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPath) {
                link.classList.add('active');
            }
        });
    });

    const loginBtn = document.getElementById("login");
    if (loginBtn) {
        loginBtn.addEventListener("click", () => {
            window.location.href = "/login";
        });
    }

    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
        logoutBtn.addEventListener("click", async function () {
            try {
                const res = await fetch("/logout", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"}
                });

                const result = await res.json();

                if (res.ok) {
                    window.location.href = "/";
                } else {
                    window.showAlertModal?.(result.error || "Logout failed", { type: "error", duration: 2000 });
                }
            } catch (error) {
                window.showAlertModal?.("Network error", { type: "error", duration: 2000 });
            }
        });
    }

    // Function to update cart count
    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart')) || [];
        const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
        const cartCountElement = document.getElementById('cart-count');
        
        if (cartCountElement) {
            cartCountElement.textContent = totalItems;
            if (totalItems > 0) {
                cartCountElement.style.display = 'inline-flex';
            } else {
                cartCountElement.style.display = 'none';
            }
        }
    }

    // Update cart count on page load
    document.addEventListener('DOMContentLoaded', function () {
        updateCartCount();
        
        // Listen for storage events to update count when cart changes in other tabs
        window.addEventListener('storage', function (e) {
            if (e.key === 'cart') {
                updateCartCount();
            }
        });
        
        // Custom event listener for same-tab updates
        window.addEventListener('cartUpdated', function () {
            updateCartCount();
        });
    });

    // Update cart count immediately if DOM is already loaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', updateCartCount);
    } else {
        updateCartCount();
    }

</script>